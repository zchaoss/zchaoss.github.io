---
title: 浏览器渲染以及性能优化
date: 2020-10-07 23:20:59
tags: 性能优化
categories: 性能优化
index_img:
---

# 浏览器渲染以及性能优化

## 浏览器渲染大致流程

### DOM树构建

- 根据HTML文档的内容，根据标签进行分词Token
- 根据Token生产对应的节点Node
- 将节点根据嵌套关系组合为一棵对象节点树DOM

>浏览器解析文档对象模型DOM是增量进行的,无需等待整个HTML文档加载完毕，便可以开始解析DOM.CSSOM解析和JavaScript脚本文件执行会阻塞HTML Parser

### CSSOM树的构建

CSSOM的解析依赖于选择器，选择器的匹配是从内到外的。所以选择器嵌套层次越深，匹配的时间会越长。

>CSSOM只解析可视部分body标签中的内容，将所有匹配的元素共同构建一个CSSOM树，从根节点一次向下，所有节点的属性向下继承

### RenderTree树的构建

利用DOM和CSSOM组合构建生成RenderTree，对应Recaculate Style

>RenderTree中包含所有渲染网页必须的节点
>无需渲染的节点不会被添加到RenderTree中，如head和display:none;的节点
>visibility: hidden;的节点会添加到RenderTree中


### Layout

Layout利用渲染树的信息，计算渲染树中所有节点在页面上的位置和大小。

>类似绘画中各个元素位置摆放及尺寸规划

会引起页面重新Layout的操作：所有改变节点位置和大小的操作

- 屏幕旋转
- 浏览器视窗改变
- 与大小、位置相关的CSS属性
- 增加与删除DOM元素

>Layout操作比较耗时，对于动画中频繁引起Layout的操作（元素位置移动），最好使用transform代替，可以使用GPU进行动画处理（将Layout重绘在GPU完成）


### Paint

填充Layout中的具体内容和样式，将Layout生成的区域填充为最终显示在屏幕上的像素

### 总结


1. 浏览器通过GET请求获取网页HTML，同时将增量解析HTML文档，生成DOM树
2. 解析DOM节点树时，对于需要加载的资源全部执行异步加载，但是CSS的解析、JavaScript的执行与font文件的下载会阻塞HTML Parser
3. 局部DOM树与CSSOM树构建完成后，立即组装RenderTree进行渲染


## 性能优化

### css文件

>css加载会阻塞初次渲染.浏览器在解析完css后，再进行渲染。防止样式突变带来的抖动。

**优化方式**

- 使用media=print媒体查询，虽然加载样式表，但只针对打印时才应用该样式，不会阻塞初次渲染。(只有匹配的时候才会阻塞)
- 通过DOMAPI引入CSS，可以避免阻塞.
- <link rel="preload" href="index_print.css" as="style" onload="this.rel='stylesheet'">注意preload的兼容性不是很好
- 对使用多个外链的网页请使用<link rel="dns-prefetch" href="http://www.spreadfirefox.com/">强制开启DNS 预读取，能够减少用户点击链接时的延迟。


### JS文件 

>JS脚本执行会阻塞HTML Parser；
>CSS解析会阻塞JS脚本执行：js可能会读、写CSSOM
>虽然JS会阻塞HTML Parser解析；但是浏览器的资源异步加载机制Preload会异步加载head标签内的资源



- 使用&lt;script&gt;的defer属性和async属性，defer属性适用于需要严格按照HTML文档中出现的顺序执行js文件，async属性适用于适用于无依赖的外部独立资源。


### 优化关键渲染路径

- 关键资源数---初次渲染时依赖的资源(内联资源(内联共享资源,建议采用缓存机制))
- 关键资源的体积最小---压缩文件或图片
- 关键资源网络来回数---网络传输资源消耗很多时间

### 减少reflow/repaint

>Repaint表示屏幕的一部分要重画，比如某个CSS的背景色变了。但是元素的几何尺寸没有变。
>Reflow意味着元件的几何尺寸变了，我们需要重新验证并计算Render Tree。

**触发场景：**

- 当你增加、删除、修改DOM结点时，会导致Reflow或Repaint
- 当你移动DOM的位置，或是搞个动画的时候。
- 当你修改CSS样式的时候。
- 当你Resize窗口的时候（移动端没有这个问题），或是滚动的时候。
- 当你修改网页的默认字体时。
- width, clientWidth, scrollTop等布局宽高的计算


**优化方式**

1. 不要一条一条地修改DOM的样式。与其这样，还不如预先定义好css的class，然后修改DOM的className。
2. 把DOM离线后修改。(利用documentFragment 对象)
3. 不要把DOM结点的属性值放在一个循环里当成循环里的变量。
4. 尽可能的修改层级比较低的DOM。当然，改变层级比较底的DOM有可能会造成大面积的reflow，但是也可能影响范围很小。
5. 为动画的HTML元件使用fixed或absoult的position，那么修改他们的CSS是不会reflow的
6. 千万不要使用table布局。因为可能很小的一个小改动会造成整个table的重新布局。


## 附录

什么是白屏和FOUC(无样式内容闪烁)?
>不同的浏览器对于CSS和HTML的处理方式不同，有的是等待CSS加载完成之后，对HTML元素进行渲染和展示(白屏问题)。有的是先对HTML元素进行展示，然后等待CSS加载完成之后重新对样式进行修改(FOUC无样式内容闪烁)

**参考：**

[Web性能优化](https://segmentfault.com/a/1190000008693178?share_user=1030000008431166&utm_source=Weibo&utm_medium=shareLink&utm_campaign=socialShare#articleHeader4)
[浏览器渲染解析](http://coolshell.cn/articles/9666.html)
[JAVASCRIPT 装载和执行](http://coolshell.cn/articles/9749.html)
[浏览器工作原理分析与首屏加载](https://www.chengrang.com/how-browsers-work.html)